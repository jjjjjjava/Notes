[toc]

## 概念

### 异构网络

异构网络中不同的组件可能使用不同的操作系统、通信协议、硬件或技术，因此需要特殊的协议或桥接设备来使它们能够协作。

### vsoa中的异构

VSOA中的异构主要是使用不同的总线进行不同网络域间的连接，这些总线具有各种不同的属性。

### vsoa异构总线代理服务器

而VSOA异构总线代理服务器将来自服务端/客户端的网络帧转化为总线帧，并与总线进行沟通，借助总线向其它网络域发送数据。

VSOA总线代理设备服务器应该在这些总线之间没有任何区别。



## 原理

VSOA客户端调用由VSOA代理服务器提供的API时，VSOA帧将被转换为总线帧，通过总线进行交付（代理服务不直接操作总线，而是与总线设备的微服务通信）。具体如下图所示。

![image-20231010094905252](C:\Users\jjjjjjava\Nutstore\1\我的坚果云\typora\typora-pic\image-20231010094905252.png)



## 实现

### 客户端

1. 客户端向位置服务器查询服务端地址，如果服务端不在本地网络或以太网中运行，位置服务器会返回null
2. 位置服务器返回null后，客户端知道是异构网络，需要转接访问，因此会将包转发给代理服务器
3. 代理服务器查询代理路由表，以查找到要是有的总线通道服务器
4. 代理服务器将RPC调用转发到目标总线服务器，并异步等待响应。
5. 总线服务器和服务端的总线服务器交换数据
6. 总线服务器获取到来自客户端的数据，转发给客户端

具体流程如下图所示

![image-20231010095553549](C:\Users\jjjjjjava\Nutstore\1\我的坚果云\typora\typora-pic\image-20231010095553549.png)

第二点是：如果它内部要用到发布和订阅以保证数据交流的及时性和减少服务器端的负载，那改用rpc是否可行。	

### 服务端

1. 代理服务器订阅总线服务器发布的数据，以及时获取总线服务器接收到的数据帧
2. 代理服务器解析数据帧，从帧报头中获取服务端域名
3. 代理服务器查询位置服务器获取服务端地址
4. 代理服务器对服务端进行rpc调用
5. 服务端返回结果给代理服务器
6. 代理服务器将结果返回给总线服务器

![image-20231010100345788](C:\Users\jjjjjjava\Nutstore\1\我的坚果云\typora\typora-pic\image-20231010100345788.png)



### 代理服务器的路由表

代理服务器路由表记录有关服务器及其所在总线通道的信息。

存储单元结构如下：

服务器名称|总线服务器|总线通道|地址定位|活超时| |::::::::::::::::::::::::::::::::| z_server | can | 0 | 0x11 | 60000 |



### 代理服务器的路由表keepalive

代理服务器定期向路由器表中的服务记录发送健康检查RPC。当应用程序服务响应调用时，代理服务器将更新表中的“alive timeout”。当“alive timeout”数为零时，代理服务器将不再与应用服务器通信。

一旦应用服务器启动，它应该宣布它的诞生，向本地代理服务器发送广播RPC。代理服务器应该遍历总线通道以发布服务器启动的消息。总线会把信息发送给其它网域的代理服务器，其它网域的代理服务器会更新自身的路由表以记录应用服务器的信息



### 代理服务器总线通道表

代理服务器总线通道表记录了它可以访问的所有总线服务器。服务器名|总线通道| |:-:|:-:| can | 0 |







```JSON
{
   "local_server": [ // 本地服务列表
      {
           "server": "A1",
           "host": "127.0.0.1",
           "port": 1234
      }
  ],
   "proxy_server": [ // 代理服务列表
      {
           "name": "A2",
           "local_port": 10001,
           "proxy_name": "com0",
           "station_no": 0
      }
  ],
   "proxy_bus": [ // 代理总线连接方式
      {
           "name": "com0",
           "type": "232",
           "connection": {
               "interface": "ttyUSB0",
               "baud_rate": 115200,
               "data_bits": 7,
               "parity": 1,
               "stop_bit": 0
          }
      },
      {
           "name": "can0",
           "type": "can",
           "connection": {
               "interface": "can0",
               "baud_rate": 500000,
               "station_no": 1
          }
      }
  ]
}
```




