[toc]

## 概览

设备与驱动程序主要包括以下几个术语：

1. 设备：连接到总线上的物理设备或虚拟对象
2. 驱动：负责探测并关联设备的代码实体，同时也会执行管理设备的功能
3. 总线：为其它设备提供接入点的设备

思考：

1. 总线也是一种设备，设备需要驱动，总线也要驱动。
2. 总线是硬件之间的通信信道



本节主要围绕以下几个重要的数据结构

1. bus_type，表示某种类型的总线（如：USB，PCI）
2. device_driver表示一个能够处理特定总线上特定设备的驱动程序
3. device数据结构表示一个连接到总线上的设备



## 总线核心驱动

总线也是一种设备，它是管理总线设备的驱动

主要负责以下工作

1. 内核中注册一个总线
2. 允许设备驱动的注册
3. 负责设备和设备驱动的匹配
4. 运行总线控制器驱动的注册，该驱动的职责是发现设备和配置资源

总线核心驱动主要包含以下几个重要的内容：

### bus_type

在总线核心驱动中，会为一个总线分配一个bus_type数据结构来表示该总线，同时通过bus_register（）函数将该数据结构注册到内核的总线类型链表中

### klist_devices

bus_type数据结构有一个成员变量指向subsys_private数据结构的指针

subsys_private数据结构中有klist_device数据成员，该成员以列表的方式维护该总线中的所有设备，总线控制器驱动扫描到总线上的设备时，会调用device_register函数更新该链表

### klist_drivers

同样是subsys_private数据结构中的指针，它以链表的方式维护所有能处理该总线上设备的驱动，当驱动初始化自己的时候，调用driver_register函数来更新该链表

### 总结

1. 当新设备插入系统时，总线控制器会侦测到该设备，并调用device_register函数将该设备注册到该总线中。然后会将device数据结构中的parent变量设置为该总线
2. 同时，总线控制器会一次遍历总线上关联的驱动，查找到一个合适的驱动以支持该设备。
3. 找到驱动后，会调用bus_type中的match函数，检查该驱动是否可以支持该给定的设备，如果支持，就会将device数据结构中的driver变量设置为相应的驱动





## 总线控制器驱动

主要负责发现并注册设备

## 设备驱动

负责与设备进行绑定，当驱动与设备绑定后，驱动的probe回调函数会被调用，设备的配置信息也会通过设备树获得。



## Linux设备模型

设备模型如下图所示：描述了总线驱动，驱动，总线控制器驱动，设备，内核子系统之间的关系。

![image-20230925110443173](C:\Users\jjjjjjava\Nutstore\1\我的坚果云\typora\typora-pic\image-20230925110443173.png)





## 设备树

### 设备树定义

设备树是一个由节点构成的树状数据结构，节点用于描述系统中的设备。每个节点通过属性/值对来描述其表示的设备的特性。

### 设备树的两种文件类型

设备树在内核代码中通过一组文本文件描述。在bspyulong810a/SylixOS/res/dts中可以找到两种文件类型：

*.dtsi文件是设备树的头文件，用来描述多个平台共用的 硬件结构

*dts是设备树源文件，描述某个具体的硬件平台。

设备树中有如下文件：common.dtsi，dkit_ddr3.dts，dkit_ddr4.dts，oa1801-ddr3.dts，0a1801-ddr4.dts，oa1901-dummy-clk-asic.dtsi,oa1801-full-clk-asic.dtsi,oa1801-half-clk-asic.dtsi

### 设备树的作用

设备树主要有以下几个作用

#### 平台区分

内核会通过设备树中的信息来识别机器类型。如：`compatible = "orbita,oa1801"`。这就是orbita公司的oa1801机型。

理论上来说，特定的硬件平台不会影响内核，因为所有平台的细节（硬件信息）都会完美的被设备树描述出来，但是很可惜，硬件不完美，所以内核需要再启动早期识别出具体的机型，这样就有机会执行机型特有的硬件修复代码

#### 运行时配置

大多数情况下，设备树将作为uboot与内核传递数据的唯一方法，所以内核参数，镜像位置等运行时的配置项也可以通过设备树传递，这些数据一般存放在`/chosen`节点中。

例：下面就是内核启动的参数。

` bootargs = "ncpus=4 kdlog=no kderror=yes kfpu=no heapchk=yes hz=1000 rfsmap=/boot:/media/sdcard0,/:/media/sdcard1";`

#### 设备填充

在机型失败完成并解析完早期的配置信息后，内核的初始化就可以依靠设备树的信息按照常规方式继续了。

如：内核按照设备树中描述的硬件信息来发现和识别这些硬件组件。

这也是设备树的主要功能，让内核来发现和识别硬件，并使用驱动，将硬件注册到内核子系统中。