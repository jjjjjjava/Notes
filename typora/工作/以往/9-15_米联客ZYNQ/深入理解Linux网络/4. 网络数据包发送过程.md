[toc]



# 网络发送数据概览



<img src="C:\Users\jjjjjjava\AppData\Roaming\Typora\typora-user-images\image-20230918144131797.png" alt="image-20230918144131797" style="zoom:150%;" />



# 网卡启动准备

在这个阶段，网卡要分配和初始化多个接受队列和传输队列RingBuffer





# 数据从进程到网卡的过程

## 系统调用层

程序中send函数使用sendto系统调用，主要完成以下几件事：

1. 在内核中，将真正的socket找出来，这个对象中记录着各种协议栈的函数地址
2. 构造一个struct msghdr对象，保存用户要发送的数据的信息，如：buffer地址，数据长度什么的都装进去。
3. 带着用户要发送的数据的信息进入协议栈。



## 协议栈

### 传输层处理

传输层主要完成数据拷贝和构造的任务

#### 传输层数据拷贝

在核空间中分配多个skb内存，构造skb发送队列，将用户在用户态中要发送的数据拷贝进去。

#### 传输层数据构造

1. 找到socket上具体协议的构造函数，对于UDP协议，就是udp_sendmsg
2. 调用该函数，在用户数据的基础上构造udp头部。
3. 数据发送至网络层进行进一步处理





### 网络层处理

网络层主要完成以下任务

1. 查找并设置路由项（即根据本机路由配置确定数据包从源主机传输到目标主机的路径），最终知道该通过哪个网卡，哪个网关将数据发送出去。找到后缓存到socket上，下次在发送数据就不用查了
2. 在udp数据包的基础上封装ip头部
3. netfilter过滤，决定哪些数据包允许通过、哪些数据包应该被阻止或拒绝
4. skb切分，数据包大于MTU（最大传输单元）时，数据包进行分片。
5. 继续传到下一层





### 邻居子系统

邻居子系统是位于网络层和数据链路层中间的一个系统，

主要完成以下任务：

1. 查找和创建邻居项	
   1. **发现邻居**：首先，本地设备需要发现与其直接相邻的其他设备。
   2. **查找邻居项**：一旦发现邻居设备，本地设备会尝试查找已知的邻居项，以确定是否已经有关于该邻居的信息。
   3. **创建邻居项**：如果在邻居缓存或表中找不到匹配的记录，本地设备可能会创建一个新的邻居项。这包括将邻居设备的信息（如IP地址、MAC地址、接口信息等）添加到邻居缓存或表中。创建邻居项后，本地设备就可以使用这些信息进行通信。
   4. **维护邻居项**：一旦邻居项被创建，本地设备通常会定期维护这些项，以确保它们仍然有效。
2. 封装MAC头
3. 传到更下层的网络设备子系统。





### 网络设备子系统

网络设备子系统主要完成以下任务

1. 选择网卡中的发送队列，注意：这个发送队列不是传输RingBuffer。
2. 将skb入队
3. 循环从发送队列中取出skb并发送。当quota用尽或者其他进程需要cpu是会触发软中断。
4. skb发送实际是调用驱动程序发送数据。





## igb网卡驱动发送

这时已经出了协议栈了，网卡驱动主要完成以下任务：

1. 获取设备的回调函数集合ops
2. 从ops中调用发送回调函数，将数据包传给网卡设备。
   1. 回调函数首先从发送队列中取下来一个元素，并将skb挂到该元素上
   2. 然后调用map进行DMA映射，将skb映射到网卡可访问的内存DMA区域，以运行设备通过DMA从RAM中读取数据。
3. 此时网卡就会进行真正的数据发送。